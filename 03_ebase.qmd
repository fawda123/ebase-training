---
lightbox: true

execute:
  echo: true
---

# Using EBASE {#sec-ebase}

## Lesson Outline

This lesson will explain the basic theory behind ecosystem metabolism and how EBASE is used to estimate key parameters.  EBASE is a Bayesian implementation for estimating metabolism that differs from more conventional approaches.  We'll also explore the main functions of EBASE to estimate metabolism, how the Bayesian approach can be used to incorporate prior knowledge, and interpret the results. 

## Learning Goals

- Understand the basic theories of EBASE
- Understand the Bayesian approach to estimating metabolism
- Learn how EBASE is used to estimate key parameters
- Use the main functions of EBASE to estimate metabolism
- Interpret the results of EBASE

## The EBASE method

[Lesson @sec-intro] provided a general description of ecosystem metabolism and why it's an important measure of ecosystem health.  The EBASE approach follows these general principles but differs in the core model for estimating production, respiration, and gas exchange and the statistical approach for how the parameters for each are estimated.  Let's revisit the core metabolic equation: 

$$ 
NEM = P - R
$$

Net ecosystem metabolism ($NEM$) is simply the difference between processes that produce organic matter (production or $P$) and those that consume organic matter (respiration or $R$).  

We can estimate these rates from the dissolved oxygen ($DO$) time series by using the rate of change of $DO$ per unit time and accounting for gas exchange $D$.  Water column depth ($Z$) is used to estimate metabolism as an areal rate. 

$$
Z\frac{dC_d}{dt} = P - R + D
$$

Methods for estimating metabolism from the dissolved oxygen time series vary in how each of the key parameters are modeled.  The core equation for EBASE is the same as the previous but expanded using methods for estuarine applications: 

$$
Z\frac{dC_d}{dt} = aPAR - R + bU_{10}^2\left(\frac{Sc}{600} \right)^{-0.5} \left(C_{Sat} - C_d \right )
$$

$aPAR$ is production ($P$), $R$ is respiration, and the last term is gas exchange [$D$, @Wanninkhof14].  The required input data to fit this model was described in [Lesson @sec-dataprep].  Three of these inputs are used directly in the equation as $C_d$ for dissolved oxygen, $PAR$, and wind speed as $U_{10}^2$ (or squared wind speed at ten meters above the surface).  The other terms are the Schmidt number ($S_c$) and dissolved oxygen at saturation ($C_{sat}$), both of which are calculated from water temperature and salinity in the input data. 

The remaining terms $a$, $R$, and $b$ are estimated during the model fitting process, which we'll discuss in the next section.  All three provide important information about metabolic processes and are useful on their own to understand ecosystem function.

* $a$: The light efficiency parameter as $\left(mmol~O_2~m^{-2}~d^{-1}\right) / \left(W~m^{-2}\right)$, yields production when multiplied by $PAR$.  This is a measure of how efficiently light is converted to organic matter.  It provides similar information as a P/I curve by showing how production changes with light availability.
* $R$: The respiration rate as $mmol~O_2~m^{-2}~d^{-1}$, is the rate at which organic matter is consumed.
* $b$: The sensitivity of gas exchange to wind speed as $\left(cm~h^{-1}\right) / \left(m^2~s^{-2}\right)$.

Although the core model equation may seem complicated, its formulation was chosen to describe dominant processes that influence metabolism in an estuarine setting.  The details for this justification can be found in @Beck2024.

## The Bayesian approach

Both the open-water method presented by @Odum56 and EBASE similarly use the rate of change of $DO$ to estimate metabolism.  However, the Bayesian approach used in EBASE differs in how the parameters are estimated and has several key advantages.  

Modern statistical approaches to modelling can broadly be described as conventional "frequentist" methods or Bayesian.  The former describes standard and more commonly used methods where a model is fit to a dataset to support a hypothesis, as in a simple linear regression.  Bayesian approaches turn the paradigm around by asking the question "what is the likelihood of the data given a model?".  

Bayesian approaches are fundamentally linked to Bayes theorem that describes the likelihood of observing an event as depending on the likelihood that other events have occurred. In model speak, this means we can estimate the posterior distribution of a parameter given a prior distribution.  For EBASE, we can establish a set of prior distributions of likely values for each of the unknown parameters, $a$, $R$, and $b$.  These prior distributions are used to create a refined estimate for the posterior distributions given the data that is presented to the model. The prior distributions can be precise (informed) or cover a range of potential values (uninformed).  

The default prior distributions for EBASE were based on a likely range of values for each parameter that were informed by published results [primarily @caffrey2004; details in @Beck2024].  You can create a plot of these prior distributions using the `prior_plot` function in EBASE. 

```{r}
#| fig-height: 3
#| fig-width: 8
library(EBASE)

prior_plot()
```

Running EBASE with the default arguments will use these prior distributions to estimate the parameters.  We'll discuss how to change these values later in the lesson if you have additional prior information. 

Finally, the Bayesian approach in EBASE uses an MCMC (Markov Chain Monte Carlo) method to estimate the posterior distributions.  This is implemented using the [JAGS](https://mcmc-jags.sourceforge.io/) software which was part of the installation during [setup](setup.qmd#sec-instjags) for the workshop.  These methods are used to estimate the posterior distributions by repeated sampling of the priors given the data until a stable estimate is reached (i.e., convergence) using a Markov Chain.  Because of this, estimation can take a while and we'll talk about arguments in EBASE to control the process.  

## EBASE minimal example

Below is a minimal example of how to use EBASE with the example dataset provided in the package. We'll subset only a few days so that we can run the example in real time.  Some helper functions from dplyr are used to subset the data. 

```{r}
library(dplyr)

# dates to subset
dts <- as.POSIXct(c("2012-06-01 00:00:00", "2012-06-05 00:00:00"), tz = 'America/Jamaica')

# subset exdat
dat <- exdat |> 
  filter(DateTimeStamp >= dts[1] & DateTimeStamp <= dts[2])

head(dat)
```

Now we run EBASE using the subsettet data and the default arguments.  We must supply values for the `interval` argument that defines the timestep in data in seconds and the water column depth `Z` in meters, which we can get from the metadata. 

```{r}
# run ebase
res <- ebase(dat, interval = 900, Z = 1.85)

head(res)
```

The results are returned as a data frame with instantaneous metabolic estimates for areal gross production (O2 mmol m$^{-2}$ d$^{-1}$, `P` or $aPAR$), respiration (O2 mmol m${^{-2}$ d$^{-1}$, `R`), and gas exchange (O2 mmol m$^{-2}$ d${^-1}$, `D` or the remainder of the equation from above, positive values as ingassing, negative values as outgassing).  

Additional parameters estimated by the model that are returned include `a` as (mmol O$_2$ m$^{-2}$ d$^{-1}$)/(W m$^{-2}$) and `b` as (cm h$^{-1}$)/(m$^2$ s$^{-2}$). We also see modelled DO as DO$_{mod}$ and various convergence metrics.  The upper and lower credible intervals for each estimated parameter are also provided by $lo$ or $hi$ suffixes, which we'll describe later to assess model fit. 

## EBASE full example

## Next steps

You now understand the basics of ecosystem metabolism using EBASE and how it's used to estimate key parameters using a Bayesian approach.  We've explored additional functions in EBASE to help interpret the results, which include an evaluation of goodness of fit and various plotting methods.  Next, we'll explore the EBASE results in more detail to demonstrate how the results can inform the understanding of ecosystem health and function.